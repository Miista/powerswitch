<style>
  body {
    min-width:357px;
    overflow-x:hidden;
  }

  img {
    margin:5px;
    border:2px solid black;
    vertical-align:middle;
    width:75px;
    height:75px;
  }

  .tab.selected {
    background-color: #ff00ff
  }
</style>

<body>
  <input id="input"/>
  <div id="tabs_list">

  </div>
</body>

<script>
  var background = chrome.extension.getBackgroundPage();

  var selected_index = 0;
  var matching_tabs = [];

  var input = document.getElementById("input");
  var onKeyPress = function(event) {
    console.log('onKeyPress');

    var is_up_or_down = false;
    if (event.keyCode === 38) { // up
      if (selected_index > 0) {
        selected_index--;
      }
      is_up_or_down = true;
    } else if (event.keyCode === 40) { // down
      if (selected_index + 1 < matching_tabs.length) {
        selected_index++;
      }
      is_up_or_down = true;
    } else if (event.keyCode === 13) {
      selectTab(matching_tabs[selected_index]);
    }

    if (is_up_or_down) {
      updateAndDisplayMatchingTabs();
      event.stopPropagation();
      event.preventDefault();
    }
  };
  input.addEventListener('keydown', onKeyPress, /*useCapture=*/ false);
  input.autocomplete = 'off';

  var selectTab = function(tab) {
    chrome.windows.getCurrent(function(window) {
      chrome.tabs.update(tab.id, {selected: true});
      chrome.windows.remove(window.id);
    });
  };

  var updateAndDisplayMatchingTabs = function() {
    console.log('updateAndDisplayMatchingTabs');
    var tabs_list_div = document.getElementById('tabs_list');

    tabs_list_div.innerHTML = "";
    var filter_text = input.value.toLowerCase();

    chrome.tabs.getCurrent(function(this_tab) {
      var shouldShowTab = function(tab) {
        return tab.title.toLowerCase().indexOf(filter_text) !== -1;
      };

      var other_tabs = background.ordered_tabs.filter(function(tab) {
        return tab.id !== this_tab.id;
      });

      if (other_tabs.length > 0) {
        other_tabs.push(other_tabs[0]);
        other_tabs = other_tabs.slice(1);
      }

      matching_tabs = other_tabs.filter(function(tab) {
        return shouldShowTab(tab);
      });

      matching_tabs.forEach(function(tab, tab_index) {
        console.log('tab ' + this_tab);

        var rendered_tab = document.createElement('div');
        rendered_tab.innerText = tab.title;

        var class_value = 'tab';
        if (tab_index === selected_index) {
          class_value += ' selected';
        }
        rendered_tab.className = class_value;
//        console.log(tab.title + ', ' + tab_index + ', ' + class_value);

        tabs_list_div.appendChild(rendered_tab);
        rendered_tab.onclick = function(event) {
          selectTab(tab);
        };
      });
    });
  };

  setTimeout(function() {
    updateAndDisplayMatchingTabs();
    var input = document.getElementById("input");
    input.focus();
    input.addEventListener("input", function(event) {
      selected_index = 0;
      updateAndDisplayMatchingTabs();
    }, /*useCapture=*/ false);
  }, 1);

</script>
