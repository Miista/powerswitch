<style>
  body {
    min-width:357px;
    overflow-x:hidden;
  }

  img {
    margin:5px;
    border:2px solid black;
    vertical-align:middle;
    width:75px;
    height:75px;
  }

  .tab.selected {
    background-color: #ff00ff
  }
</style>

<body>
  <input id="input"/>
  <div id="tabs_list">

  </div>
</body>

<script>
  var background = chrome.extension.getBackgroundPage();

  var selected_index = 0;
  var matching_tabs = [];

  var input = document.getElementById("input");
  var onKeyPress = function(event) {
    console.log('onKeyPress');

    var is_up_or_down = false;
    if (event.keyCode === 38) { // up
      if (selected_index > 0) {
        selected_index--;
      }
      is_up_or_down = true;
    } else if (event.keyCode === 40) { // down
      if (selected_index + 1 < matching_tabs.length) {
        selected_index++;
      }
      is_up_or_down = true;
    }

    if (is_up_or_down) {
      updateAndDisplayMatchingTabs();
      event.stopPropagation();
      event.preventDefault();
    }
  };
  input.addEventListener('keydown', onKeyPress, /*useCapture=*/ false);
  input.autocomplete = 'off';

  var updateAndDisplayMatchingTabs = function() {
    console.log('updateAndDisplayMatchingTabs');
    var tabs_list_div = document.getElementById('tabs_list');

    tabs_list_div.innerHTML = "";
    var filter_text = input.value.toLowerCase();

    chrome.tabs.getCurrent(function(current_tab) {
      console.log('current_tab ' + current_tab);
      matching_tabs = [];
      background.ordered_tabs.forEach(function(tab) {
        if (tab.title.toLowerCase().indexOf(filter_text) === -1 ||
                tab.id === current_tab.id) {
          return;
        }
        var tab_index = matching_tabs.length;
        console.log('tab ' + current_tab);

        matching_tabs.push(tab);
        var rendered_tab = document.createElement('div');
        rendered_tab.innerText = tab.title + '###' + tab.url;

        var class_value = 'tab';
        if (tab_index === selected_index) {
          class_value += ' selected';
        }
        rendered_tab.className = class_value;
//        console.log(tab.title + ', ' + tab_index + ', ' + class_value);

        tabs_list_div.appendChild(rendered_tab);
        rendered_tab.onclick = function(event) {
          chrome.windows.getCurrent(function(window) {
            chrome.tabs.update(tab.id, {selected: true});
            chrome.windows.remove(window.id);
          });
        };
      });
    });
  };

  setTimeout(function() {
    updateAndDisplayMatchingTabs();
    var input = document.getElementById("input");
    input.focus();
    input.addEventListener("input", function(event) {
      selected_index = 0;
      updateAndDisplayMatchingTabs();
    }, /*useCapture=*/ false);
  }, 1);

</script>
